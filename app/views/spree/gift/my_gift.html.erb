<div id="cool-choice-home"  v-cloak>
  <div id="section-1" class="section-1" style="padding-bottom: 140px">
    <div class="container">
      <div class="title"><%= Spree.t(:"homepage.content_title_magic") %></div>
      <div class="sub-title">
        <div class="line"></div><%= Spree.t(:"homepage.content_title_choose") %>
        <div class="line"></div>
      </div>
      <div class="content clearfix">
        <% function_list = ['Anti-Aging', 'Beauty', 'Brain Care', 'Digestive Care', 'Energy', 'Eye Care', 'Heart Care', 'Immune Support', 'Joint Care', 'Liver Care', 'Lung Care', 'Men\'s Vitality', 'Sleep Support', 'Stress Management'].map { |e| e.sub('\'', '').sub(/\s/, '_') } %>
        <% function_list.each_with_index do |function, i| %>
          <div class="choose-box <%= function %>">
            <label for="<%= function %>" class="choose-label"><%= image_tag('home/icon-'.concat(function).concat('@2x.png'), {"class"=> "img", "id" => "image_#{i+1}", "v-on:click" => "action_select(#{i+1})"}) %>
              <div class="text" id="text_<%= i+1 %>">
                <%= Spree.t('homepage.content_function_' + function) %>
              </div>
            </label>
            <div class="information">i</div>
            <input type="checkbox" id="<%= function %>" value="<%= function %>" v-model="result" class="checkbox cb_<%= i+1 %>"/>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="section-4" v-if="result.length == 3">
    <div class="container"><%= image_tag("home/product@2x.png", class: "bar") %>
      <div class="func col-sm-3">
        <div class="title"><%= Spree.t(:"homepage.bar_choose") %></div>
        <div v-for="n in 3" :class="[result[n] ? 'bg-'.concat(result[n], ' hover') : '']" class="box"><%= image_tag("home/icon_delet@2x.png", {class: "delete", "@click"=>"result.splice(n, 1)"}) %></div>
      </div>
      <div class="qty col-sm-2">
        <div class="title"><%= Spree.t(:"homepage.bar_qty") %></div>
        <div class="select">
          <select v-model="type" class="type">
            <!-- <option value="day">{{ num }} <%= Spree.t(:"homepage.bar_day") %></option> -->
            <!-- <option value="week">{{ num + ' ' + types[0] }}</option> -->
            <option value="month">{{ num + ' ' + types[1] }}</option>
          </select>
        </div>
        <!-- <div v-if="type == 'day'" class="detail"><%= Spree.t(:"homepage.bar_pack_1") %></div> -->
        <div v-if="type == 'week'" class="detail"><%= Spree.t(:"homepage.bar_pack_2") %></div>
        <div v-if="type == 'month'" class="detail"><%= Spree.t(:"homepage.bar_pack_3") %></div>
      </div>
      <div class="cart" style="height: 100%; float: right;vertical-align: middle;margin-right: 64px" v-if="result.length">
        <span style="height: 100%; vertical-align: middle; display: inline-block"></span><a v-on:click='action_checkout' class="button" style="margin: 0; padding: 0; width: 120px"><%= Spree.t(:ok) %></a>
      </div>
    </div>
  </div>
</div>

<!-- popup ingredient details -->
<div class="more-overlay">
  <div class="close"></div>
  <% url_list = ['http://extramel.com/', 'http://www.gelita.com/en/products/verisol', 'http://cognizin.com/', nil, nil, 'http://www.lutemax2020.com/', nil, 'http://nutriscienceusa.com/beta-glucan/', 'http://greengrownglucosamine.com/', nil, nil, nil, nil, 'http://www.suntheanine.com/
'] %>
  <% function_list.each_with_index do |function, index| %>
    <div id="<%= 'ingredient_' + function %>" class="view">
      <a class="close"><%= image_tag("ingredient/button-off@2x.png") %></a>
      <img src="<%= asset_path 'home/icon-'.concat(function).concat('@2x.png') %>" class="icon">
      <div class="title"><%= Spree.t('ingredient.function_' + function) %></div>
      <div class="sub-title"><%= Spree.t('ingredient.help_' + function) %></div>
      <p><%= Spree.t('ingredient.detail_' + function) %></p>
      <p><%= Spree.t('ingredient.contains_' + function) %></p>
      <ul>
        <li><%= Spree.t('ingredient.more1_' + function) %></li>
        <li><%= Spree.t('ingredient.more2_' + function) %></li>
        <li><%= Spree.t('ingredient.more3_' + function) %></li>
        <% if function == 'Lung_Care' %>
        <li><%= Spree.t('ingredient.more4_' + function) %></li>
        <% end %>
      </ul>
      <% if url_list[index] %>
        <p><a href="<%= url_list[index] %>" target="_blank"><%= Spree.t(:learn_more) %></a></p>
      <% end %>
      <% if function == 'Sleep_Support' %>
        <p style="font-size: 12px"><%= Spree.t('ingredient.caution1_' + function) %><br><%= Spree.t('ingredient.caution2_' + function) %></p>
      <% end %>
      <p style="font-size: 10px; margin-top: 0"><%= Spree.t('ingredient.warning1') %><br><%= Spree.t('ingredient.warning2') %></p>
    </div>
  <% end %>
</div>
<script>
  Array.prototype.clone = function() {
    return this.slice(0)
  }
  Array.prototype.and = function(a) {
    var t = this.clone()
    a.forEach(function(item){
      if (!t.includes(item)) {
        t.push(item)
      }
    })
    return t
  }
  //ingredient popup
  $("#section-1 .information").click(function() {
    $("body").append($(".more-overlay"))
    $("body").css("overflow","hidden")

    var id = $(this).parent().attr("class").split(' ')[1]
    $(".more-overlay>.close").show()
    $("#ingredient_" + id).show()
    $("body>.more-overlay").show()
    $(".more-overlay>.close").height(document.getElementById("ingredient_" + id).offsetHeight)
  })
  $(".more-overlay .close").click(function() {
    $(".more-overlay").hide()
    $(".more-overlay>div").hide()
    $(".function>.inner").removeClass('active')
    $("body").css("overflow","auto")
  })

  var vm = new Vue({
    el: '#cool-choice-home',
    data: {
      num: 1,
      type: 'month',
      sum: 39.99,
      result: [],
      processing: false,
      order_number: "<%= @order.number %>",
      order_token: "<%= @order.guest_token %>",
      mutuallyExclusiveItems: {
        5: {
          on_image: "<%= image_url("home/icon-Energy@2x.png") %>",
          on_color: "#62c0ef",
          off_image: "<%= image_url("home/icon_energy_grey@2x.png") %>",
          off_color: "#e4e4e4",
        },
        12: {
          on_image: "<%= image_url("home/icon-Mens_Vitality@2x.png") %>",
          on_color: "#5979C3",
          off_image: "<%= image_url("home/icon_sex_gray@2x.png") %>",
          off_color: "#e4e4e4",
        },
        13: {
          on_image: "<%= image_url("home/icon-Sleep_Support@2x.png") %>",
          on_color: "#7fadf0",
          off_image: "<%= image_url("home/icon_sleep_grey@2x.png") %>",
          off_color: "#e4e4e4",
        },
      },
      mutuallyExclusives: [[5, 12], [5, 13]],
      disabledFeatures: [],
      theSKU: ""
    },
    computed: {
      types: function() {
        return this.num > 1 ? ['<%= Spree.t(:"homepage.bar_weeks") %>', '<%= Spree.t(:"homepage.bar_months") %>'] : ['<%= Spree.t(:"homepage.bar_week") %>', '<%= Spree.t(:"homepage.bar_month") %>']
      },
      sum: function() {
        var price = {
          day: 3.99,
          week: 13.99,
          month: 39.99
        }
        return (price[this.type] * this.num).toFixed(2)
      },
      sku: function() {
        var hash = ["", "Anti-Aging", "Beauty", "Brain_Care", "Digestive_Care", "Energy", "Eye_Care", "Heart_Care", "Immune_Support", "Joint_Care", "Liver_Care", "Lung_Care", "Mens_Vitality", "Sleep_Support", "Stress_Management"]

        var num = this.result.slice().sort().map(function (x) { var index = hash.indexOf(x); return index < 10 ? '0' + index : index }).join('')
        this.theSKU = 'ccs' + this.type[0] + this.result.length + 'f'+ new Array(6 - num.length + 1).join('0') + num
        return this.theSKU
      },
    },

    watch: {
      theSKU: function(value, oldValue) {
        var a1 = this.features()
        var tDisabledFeatures = []
        for (var i=0; i<this.mutuallyExclusives.length; i++){
          var a2 = this.mutuallyExclusives[i].clone()
          loop:
          for (var j=0; j<a1.length; j++) {
            var t = a1[j]
            var index = a2.indexOf(t)
            if (index > -1) {
              a2.splice(index, 1)
              tDisabledFeatures = tDisabledFeatures.and(a2)
              console.log(tDisabledFeatures)
              break loop
            }
          }
        }
        this.disabledFeatures = tDisabledFeatures
      },
      disabledFeatures: function() {
        var that = this
        var a = []
        this.mutuallyExclusives.forEach(function(ta){
          a = a.and(ta)
        })
        a.forEach(function(item){
          if (that.disabledFeatures.includes(item)) {
            that.disableItem(item)
          } else {
            that.enableItem(item)
          }
        })
      },
      'result': function(val) {
        this.check_3_box(val)
        if (this.result.length < 3) {
          this.sku
        }
      }
    },
    methods: {
      disableItem: function(index) {
        document.getElementById("image_"+index).src = this.mutuallyExclusiveItems[index].off_image
        document.getElementById("text_"+index).style.color = this.mutuallyExclusiveItems[index].off_color
        document.getElementsByClassName("cb_"+index)[0].disabled = true

      },
      enableItem: function(index) {
        document.getElementById("image_"+index).src = this.mutuallyExclusiveItems[index].on_image
        document.getElementById("text_"+index).style.color = this.mutuallyExclusiveItems[index].on_color
        document.getElementsByClassName("cb_"+index)[0].disabled = false
      },
      features: function(s) {
        return [+this.sku.slice(6,8), +this.sku.slice(8,10), +this.sku.slice(10,12)]
      },
      check_3_box: function() {
        var box = document.getElementsByClassName('checkbox')
        if(this.result.length < 3) {
          for (var i = 0; i < box.length; i++) {
            if (!this.disabledFeatures.includes(i+1)) {
              box[i].disabled=false
            }
          }
        }
        else {
          for (var i = 0; i < box.length; i++) {
            if (!box[i].checked) {
              box[i].disabled=true
            }
          }
        }
      },
      validate: function(event) {
        if (this.processing) {
          return false
        }
        return this.sku.slice(6) != '000000'
      },
      action_checkout: function(event) {
        if (this.validate()) {
          this.processing = true
          var that = this
          $.ajax({
            type: 'POST',
            url: '/api/v1/orders/' + this.order_number + '/line_items?line_item[sku]=' + this.sku + '&line_item[quantity]=' + this.num + '&gift=true&order_token=' + this.order_token,
            success: function(data) {
              window.location.href = '<%= gift_path %>/my_address?token=' + that.order_token
            },
            complete: function() {
              that.processing = false
            }
          })
        }
      },
      action_select: function(index) {
        if (this.disabledFeatures.includes(index)) {
          alert("<%= Spree.t(:alert_mutual_exclusive) %>")
        }
      }
    }
  })
</script>
